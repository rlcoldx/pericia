{% extends "layout/layoutMaster.twig" %}

{% block title %}{{ titulo }}{% endblock %}

{% block body %}

<div class="content-body">
    
    <!-- row -->
    <div class="container-fluid">
        <div class="page-titles">
            <div class="d-flex flex-wrap align-items-center justify-content-between">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ DOMAIN }}">Home</a></li>
                    <li class="breadcrumb-item"><a href="{{ DOMAIN }}/agendamento">Agendamentos</a></li>
                    <li class="breadcrumb-item active"><a href="javascript:void(0)">{{ titulo }}</a></li>
                </ol>
                <div>
                    {% if 'agendamento_editar'|verifyPermission %}
                    <a href="{{ DOMAIN }}/agendamento/edit/{{ agendamento.id }}" class="btn btn-success me-2">
                        <i class="fa fa-pencil me-2"></i>Editar
                    </a>
                    {% endif %}
                    <a href="{{ DOMAIN }}/agendamento" class="btn btn-secondary">
                        <i class="fa fa-arrow-left me-2"></i>Voltar
                    </a>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12 col-lg-8">
                <!-- Dados do Cliente -->
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">
                            <i class="fa-solid fa-user me-2"></i>Dados do Cliente
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Nome</label>
                                <p class="mb-0">{{ agendamento.cliente_nome }}</p>
                            </div>
                            {% if agendamento.cliente_cpf %}
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">CPF</label>
                                <p class="mb-0">{{ agendamento.cliente_cpf }}</p>
                            </div>
                            {% endif %}
                        </div>
                        <div class="row">
                            {% if agendamento.cliente_email %}
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Email</label>
                                <p class="mb-0">
                                    <a href="mailto:{{ agendamento.cliente_email }}" class="text-primary">
                                        {{ agendamento.cliente_email }}
                                    </a>
                                </p>
                            </div>
                            {% endif %}
                            {% if agendamento.cliente_telefone %}
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Telefone</label>
                                <p class="mb-0">
                                    <a href="tel:{{ agendamento.cliente_telefone }}" class="text-success">
                                        {{ agendamento.cliente_telefone }}
                                    </a>
                                </p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Dados do Agendamento -->
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">
                            <i class="fa-solid fa-calendar me-2"></i>Dados do Agendamento
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">Data</label>
                                <p class="mb-0">
                                    <span class="badge bg-primary fs-6">{{ agendamento.data_agendamento|date("d/m/Y") }}</span>
                                </p>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">Hora</label>
                                <p class="mb-0">
                                    <span class="badge bg-info fs-6">{{ agendamento.hora_agendamento|date("H:i") }}</span>
                                </p>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">Status</label>
                                <p class="mb-0">
                                    {% if agendamento.status == 'Pendente' %}
                                        <span class="badge bg-warning fs-6">Pendente</span>
                                    {% elseif agendamento.status == 'Agendado' %}
                                        <span class="badge bg-primary fs-6">Agendado</span>
                                    {% elseif agendamento.status == 'Realizado' %}
                                        <span class="badge bg-success fs-6">Realizado</span>
                                    {% elseif agendamento.status == 'Cancelado' %}
                                        <span class="badge bg-danger fs-6">Cancelado</span>
                                    {% elseif agendamento.status == 'Aprovado' %}
                                        <span class="badge bg-success fs-6">Aprovado</span>
                                    {% elseif agendamento.status == 'Rejeitado' %}
                                        <span class="badge bg-danger fs-6">Rejeitado</span>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        <div class="row">
                            {% if agendamento.tipo_pericia %}
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Tipo de Perícia</label>
                                <p class="mb-0">{{ agendamento.tipo_pericia }}</p>
                            </div>
                            {% endif %}
                            {% if agendamento.local_pericia %}
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Local da Perícia</label>
                                <p class="mb-0">{{ agendamento.local_pericia }}</p>
                            </div>
                            {% endif %}
                        </div>
                        {% if agendamento.perito_id %}
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Perito Responsável</label>
                                <p class="mb-0">
                                    {% if perito %}
                                        <span class="badge bg-info">{{ perito.nome }}</span>
                                    {% else %}
                                        <span class="badge bg-info">Perito #{{ agendamento.perito_id }}</span>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        {% endif %}
                        {% if agendamento.observacoes %}
                        <div class="row">
                            <div class="col-12 mb-3">
                                <label class="form-label fw-bold">Observações</label>
                                <p class="mb-0">{{ agendamento.observacoes|nl2br }}</p>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

            </div>

            <div class="col-12 col-lg-4">
                <!-- Ações Rápidas -->
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">Ações</h4>
                    </div>
                    <div class="card-body">
                        {% if 'agendamento_editar'|verifyPermission %}
                        <div class="dropdown mb-2">
                            <button class="btn btn-warning w-100 dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="fa fa-exchange-alt me-2"></i>Alterar Status
                            </button>
                            <ul class="dropdown-menu w-100">
                                <li><a class="dropdown-item" href="#" onclick="alterarStatus({{ agendamento.id }}, 'Pendente')">Marcar como Pendente</a></li>
                                <li><a class="dropdown-item" href="#" onclick="alterarStatus({{ agendamento.id }}, 'Agendado')">Marcar como Agendado</a></li>
                                <li><a class="dropdown-item" href="#" onclick="alterarStatus({{ agendamento.id }}, 'Realizado')">Marcar como Realizado</a></li>
                                <li><a class="dropdown-item" href="#" onclick="alterarStatus({{ agendamento.id }}, 'Cancelado')">Cancelar</a></li>
                            </ul>
                        </div>
                        {% endif %}

                        {% if 'agendamento_deletar'|verifyPermission %}
                        <button type="button" class="btn btn-danger w-100" onclick="removerAgendamento({{ agendamento.id }}, '{{ agendamento.cliente_nome }}')">
                            <i class="fa fa-trash me-2"></i>Remover Agendamento
                        </button>
                        {% endif %}
                    </div>
                </div>

                <!-- Informações do Sistema -->
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">Informações</h4>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled mb-0">
                            <li class="mb-2">
                                <strong>ID:</strong> {{ agendamento.id }}
                            </li>
                            <li class="mb-2">
                                <strong>Criado em:</strong><br>
                                <small>{{ agendamento.data_create|date("d/m/Y H:i") }}</small>
                            </li>
                            {% if agendamento.data_update %}
                            <li class="mb-2">
                                <strong>Atualizado em:</strong><br>
                                <small>{{ agendamento.data_update|date("d/m/Y H:i") }}</small>
                            </li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Remoção</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja remover o agendamento de <strong id="nomeCliente"></strong>?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmRemover">Sim, Remover</button>
            </div>
        </div>
    </div>
</div>

<script>
let agendamentoParaRemover = null;

function removerAgendamento(id, nomeCliente) {
    agendamentoParaRemover = id;
    document.getElementById('nomeCliente').textContent = nomeCliente;
    new bootstrap.Modal(document.getElementById('confirmModal')).show();
}

function alterarStatus(id, status) {
    Swal.fire({
        title: 'Alterar Status?',
        text: `Deseja alterar o status para "${status}"?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Sim, Alterar',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch('{{ DOMAIN }}/agendamento/alterar-status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'id=' + id + '&status=' + status
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Sucesso!',
                        text: data.message,
                        timer: 2000,
                        showConfirmButton: false
                    }).then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Erro!',
                        text: data.message
                    });
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Erro!',
                    text: 'Ocorreu um erro ao alterar o status.'
                });
            });
        }
    });
}

document.getElementById('confirmRemover').addEventListener('click', function() {
    if (!agendamentoParaRemover) return;
    
    this.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Removendo...';
    this.disabled = true;
    
    fetch('{{ DOMAIN }}/agendamento/remover', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'id=' + agendamentoParaRemover
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: 'Sucesso!',
                text: data.message,
                timer: 2000,
                showConfirmButton: false
            }).then(() => {
                window.location.href = '{{ DOMAIN }}/agendamento';
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Erro!',
                text: data.message
            });
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        Swal.fire({
            icon: 'error',
            title: 'Erro!',
            text: 'Ocorreu um erro ao remover o agendamento.'
        });
    })
    .finally(() => {
        this.innerHTML = 'Sim, Remover';
        this.disabled = false;
        agendamentoParaRemover = null;
    });
});
</script>

{% endblock %}


{% extends "layout/layoutMaster.twig" %}

{% block title %}{{ titulo }}{% endblock %}

{% block body %}

<div class="content-body">
    <div class="container-fluid">
        <div class="page-titles">
            <div class="d-flex flex-wrap align-items-center justify-content-between">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ DOMAIN }}">Home</a></li>
                    <li class="breadcrumb-item"><a href="{{ DOMAIN }}/faturamento">Faturamento</a></li>
                    <li class="breadcrumb-item active"><a href="javascript:void(0)">{{ titulo }}</a></li>
                </ol>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h4 class="card-title">{{ titulo }}</h4>
            </div>
            <div class="card-body">
                <form id="formFatura">
                    {% if action == 'editar' %}
                    <input type="hidden" name="id" value="{{ fatura.id }}">
                    {% endif %}
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Agendamento <span class="text-danger">*</span></label>
                            <select name="agendamento_id" class="form-control" required>
                                <option value="">Selecione...</option>
                                {% for agendamento in agendamentos %}
                                <option value="{{ agendamento.id }}" {{ (fatura.agendamento_id|default(agendamento_selecionado.id|default('')) == agendamento.id) ? 'selected' : '' }}>
                                    {{ agendamento.cliente_nome }} - {{ agendamento.data_agendamento|date('d/m/Y') }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Cliente <span class="text-danger">*</span></label>
                            <input type="text" name="cliente_nome" class="form-control" value="{{ fatura.cliente_nome|default(agendamento_selecionado.cliente_nome|default('')) }}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">CPF/CNPJ</label>
                            <input type="text" name="cliente_documento" class="form-control" value="{{ fatura.cliente_documento|default('') }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Valor Total <span class="text-danger">*</span></label>
                            <input type="text" name="valor_total" class="form-control money" value="{{ fatura.valor_total|default('0')|number_format(2, ',', '.') }}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Valor Desconto</label>
                            <input type="text" name="valor_desconto" class="form-control money" value="{{ fatura.valor_desconto|default('0')|number_format(2, ',', '.') }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Valor Acréscimo</label>
                            <input type="text" name="valor_acrescimo" class="form-control money" value="{{ fatura.valor_acrescimo|default('0')|number_format(2, ',', '.') }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Data Emissão <span class="text-danger">*</span></label>
                            <input type="date" name="data_emissao" class="form-control" value="{{ fatura.data_emissao|default('now'|date('Y-m-d')) }}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Data Vencimento <span class="text-danger">*</span></label>
                            <input type="date" name="data_vencimento" class="form-control" value="{{ fatura.data_vencimento|default('') }}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Tipo Fatura</label>
                            <select name="tipo_fatura" class="form-control">
                                <option value="Nota Fiscal" {{ fatura.tipo_fatura|default('Nota Fiscal') == 'Nota Fiscal' ? 'selected' : '' }}>Nota Fiscal</option>
                                <option value="Recibo" {{ fatura.tipo_fatura|default('') == 'Recibo' ? 'selected' : '' }}>Recibo</option>
                                <option value="Boleto" {{ fatura.tipo_fatura|default('') == 'Boleto' ? 'selected' : '' }}>Boleto</option>
                                <option value="Outro" {{ fatura.tipo_fatura|default('') == 'Outro' ? 'selected' : '' }}>Outro</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Status</label>
                            <select name="status" class="form-control">
                                <option value="Rascunho" {{ fatura.status|default('Rascunho') == 'Rascunho' ? 'selected' : '' }}>Rascunho</option>
                                <option value="Emitida" {{ fatura.status|default('') == 'Emitida' ? 'selected' : '' }}>Emitida</option>
                                <option value="Enviada" {{ fatura.status|default('') == 'Enviada' ? 'selected' : '' }}>Enviada</option>
                            </select>
                        </div>
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Observações</label>
                            <textarea name="observacoes" class="form-control" rows="3">{{ fatura.observacoes|default('') }}</textarea>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fa-solid fa-save me-2"></i>Salvar
                        </button>
                        <a href="{{ DOMAIN }}/faturamento" class="btn btn-secondary">
                            <i class="fa-solid fa-times me-2"></i>Cancelar
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    window.DOMAIN = '{{ DOMAIN }}';
    window.ACTION = '{{ action }}';
</script>
<script src="{{ PATH }}/view/assets/js/jquery.mask.js"></script>
<script>
    $(document).ready(function() {
        $('.money').mask('#.##0,00', {reverse: true});
        
        $('#formFatura').on('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const url = ACTION === 'criar' ? DOMAIN + '/faturamento/add/save' : DOMAIN + '/faturamento/edit/save';
            
            fetch(url, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Sucesso!',
                        text: data.message,
                        timer: 2000,
                        showConfirmButton: false
                    }).then(() => {
                        window.location.href = DOMAIN + '/faturamento';
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Erro!',
                        text: data.message
                    });
                }
            });
        });
    });
</script>
{% endblock %}

